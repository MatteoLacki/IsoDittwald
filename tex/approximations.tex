%!TEX root = ../DeGaulle.tex
\section{Approximations}

	By an isotopic configuration we understand information about the number of different isotopes in the sample. For the purpose of simplicity, we focus on configurations of chemical compounds made out of carbon, hydrogen, nitrogen, oxygen, and sulfur, i.e. compounds with empirical formulas like \molecule. We underline that in general analysis is not constrained only to these elements. Observe however, that one already encompasses compounds like peptides and proteins. An isotopic configuration can be represented by an extended empirical formula 
\begin{equation}\label{long chemical formula}
	\text{\moleculeIsotopic}.
\end{equation}

In the above representation, small letters with indices represent counts of different atoms with indices displaying the number of additional neutrons an isotope has with respect to the lighest possible isotopic variant. 
Observe that $\cem{c} = \cem{c_0} + \cem{c_1}$, $\cem{h} = \cem{h_0} + \cem{h_1}$, and so on, where $\cem{c}, \cem{h}, \dots$, are atom numbers from the empirical formula \molecule. The left superscripts of big letters represent atomic numbers of different elements. The probability of such a variant is usually assumed to be a product of independent multinomial distributions
{\small\begin{equation}\label{product of multinomials}
	\cem{M} = \mathrm{Multi} \Big( \prob(\cem{^{12}C}), \prob(\cem{^{13}C}); c \Big)
	\otimes \dots \otimes 
	\mathrm{Multi} \Big( \prob(\cem{^{32}S}), \prob(\cem{^{33}S}), \prob(\cem{^{34}S}), \prob(\cem{^{36}S}); s \Big),	
\end{equation}}
where the probabilities of observing particular isotopes, $\prob(\cem{^{12}C})$, \dots, $\prob(\cem{^{36}S})$, are established in independent experiments\footnote{Consult Table \ref{basic info on isotopes table} for details.}. For instance, the probability of a given carbons configuration $(\cem{c_0}, \cem{c_1})$ equals
\begin{equation*}
	\mathrm{Multi} \left( \prob(\cem{^{12}C}), \prob(\cem{^{13}C}); c \right)
		\Big( (\cem{c_0}, \cem{c_1}) \Big) = 
	\begin{pmatrix}
		\cem{c} \cr \cem{c_0}, \cem{c_1}  
	\end{pmatrix} \prob(\cem{^{12}C})^\cem{c_0} \prob(\cem{^{13}C})^\cem{c_1}
\end{equation*}
and it should be multiplied by similar expression for hydrogen, nitrogen, oxygen and sulfur to obtain probability for expression like \eqref{long chemical formula}.



\begin{table}[ht]
	\centering
	\caption{Basic Information on Stable Isotopes, as found in \cite{Rosman1997IsotopicCompositions}.}\label{basic info on isotopes table}
	\begin{tabular}{lccll}
		\toprule
Element 	& Isotope 		& Extra Neutrons& Mass [Da] & Probability 	\\
		\midrule
\multirow{2}{*}{Carbon}  	
			& \ce{^{12}C} 	& 0 			& 12 		& 0.9893 		\\	
  			& \ce{^{13}C} 	& 1 			& 13.0033 	& 0.0107 		\\	
  		\cmidrule(r){1-5}
\multirow{2}{*}{Hydrogen}  	
			& \ce{^1H} 		& 0 			& 1.0078 	& 0.999885 		\\	
  			& \ce{^2H} 		& 1 			& 2.0141 	& 0.000115 		\\	
  		\cmidrule(r){1-5}	
\multirow{2}{*}{Nitrogen}  	
			& \ce{^{14}N} 	& 0 			& 14.0031 	& 0.99632 		\\	
  			& \ce{^{15}N}	& 1 			& 15.0001 	& 0.00368 		\\	  	  
  		\cmidrule(r){1-5}	
\multirow{3}{*}{Oxygen}  	
			& \ce{^{16}O} 	& 0 			& 15.9949 	& 0.99757 		\\	
  			& \ce{^{17}O}	& 1 			& 16.9991 	& 0.00038 		\\	  	  	
  			& \ce{^{18}O}	& 2 			& 17.9992 	& 0.00205 		\\	  	  
  		\cmidrule(r){1-5}	
\multirow{4}{*}{Sulfur}  	
			& \ce{^{32}S} 	& 0 			& 31.9721 	& 0.9493 		\\	
  			& \ce{^{33}S}	& 1 			& 32.9714 	& 0.0076 		\\	  	  
  			& \ce{^{34}S}	& 2 			& 33.9679 	& 0.0429 		\\
  			& \ce{^{36}S}	& 4 			& 35.9671 	& 0.0002 		\\		
		\bottomrule
	\end{tabular}
\end{table}

A {\it localised fine structure} with $K$ extra neutrons is simply a subset of all possible configurations \eqref{long chemical formula} with additional constraint 
\begin{equation}\label{Simple Diophantine Equation}
	\cem{c_1} + \cem{h_1} + \cem{n_1} + \cem{o_1} + 2 \cem{o_2} + \cem{s_1} + 2 \cem{s_2} + 4 \cem{s_4} = K.
\end{equation}

The main point of interest in the localised fine structure problem is how to efficiently derive a possibly short list of the most probable isotopic configurations that satisfy \eqref{Simple Diophantine Equation}. The number of extra neutrons, $K$, should take values between zero and $c + h + n + 2o + 4s$ -- the maximal number of extra neutrons a molecule with a fixed amount of elements can have. Numbers $2$ and $4$ are simply the maximal number of extra neutrons that oxygen and suflur can absorb respectively, see Table \ref{basic info on isotopes table}.


We approximate the {\it full distribution} \eqref{product of multinomials} by a product of Poisson laws.
	

\begin{lemma}\label{weak convergence of multinomial to Poissons lemma}
	Consider a multionomial distribution 
$$ 
	\mathrm{Multi}^{[n]}(r_0, r_1, \dots, r_w; n) = 
	\begin{pmatrix}
		n \cr r_0, r_1, \dots, r_w
	\end{pmatrix} 
	p_{0,n}^{r_0}  p_{1,n}^{r_1} \dots p_{w,n}^{r_w}.
$$
	If \,\,$\lim_{n\to \infty} n p_{k,n}= \lambda_k$ exist for $k=1,\dots, w$ then 
\begin{equation}\label{weak convergence of multionial to Poissons equation}
	\mathrm{Multi}^{[n]} \rightharpoonup \delta_\infty \otimes \mathrm{Poiss}( \lambda_1) \otimes \dots \otimes \mathrm{Poiss}( \lambda_w ),	
\end{equation}
	where $\delta_\infty$ is a measure concentrated on $\infty$ and $\mathrm{Poiss}$ is the Poisson distribution, 
$$
	\mathrm{Poiss}(\lambda)(k) 	= \frac{\lambda^k}{k!}e^{-\lambda}.
$$
\end{lemma}
The proof is well known in the literature and we omit it\footnote{It makes part of common knowledge: mathematicians are more concerned about measuring the quality of this approximation, as in \cite{Roos1999OnTheRateOfMultivariatePoissonConvergence}.}. 


Note that the approximation assumes that we enlarge the number of trials in the multinomial distribution to infinity. In the context of our model this would correspond to infinite enlargement of the compound so that only the lightest isotopes of differenet elements would appear infinitely often, other taking any finite value. Thus, the Poisson approximation enlarges the state space of the problem to configurations that are nonphysical. The interpretational shortcomings are overweighted however by the emerging independence of the numbers of isotope counts. 


We tackle the problem of infinite numbres of lightest isotopes in the following way: we assume, that the configurations to which we can prescribe the approximative distributions are simply the counts of the heavier isotopes and call that a reduced configuration. In the example studied in this paper it amounts to
\begin{equation}\label{short chemical formula}
	\text{\heavyMoleculeIsotopic}.
\end{equation}
The reduction is a common approach to the problem; confront \cite{Feller1968IntroductionToProbability}. Observe, that for a reduced isotopic configuration the constraint \eqref{Simple Diophantine Equation} is still a valid one, being expressed only in terms of numbers of not the lightest isotopes. 


Another question worth addressing what should be chosen for $n$, while applying Lemma \ref{weak convergence of multinomial to Poissons lemma}. It is an important question, since for cerain values $n$ the approximation works better. A detailed description of this phenomenon can be found in \cite{Roos1999OnTheRateOfMultivariatePoissonConvergence}. Since we approximate each multinomial distribution in \eqref{product of multinomials} it is natural to consider more than one value: one should look at the numbers of different elements in the chemical compound, i.e. on the empirical formula \molecule. The bigger the minimal number atoms, the better the approximation should be\footnote{More precisely: the smaller is the total variance difference between the approximation and the approximated term.}. In case of peptides and proteins, Senko et al. \cite{Senko1995Determination} introduced the concept of avergine, an averaged chain of $m$ amino acids, with empirical formula 
\begin{equation*}
	\cem{C}_{\lfloor m \times 4.9384\rfloor} 
	\cem{H}_{\lfloor m \times 7.7583\rfloor} 
	\cem{O}_{\lfloor m \times 1.4773\rfloor} 	
	\cem{N}_{\lfloor m \times 1.3577\rfloor} 
	\cem{S}_{\lfloor m \times 0.0417\rfloor},
\end{equation*}
We infer $n$'s from that relationship while using Lemma \ref{weak convergence of multinomial to Poissons lemma} for peptides and proteins.


Finally, in the approximation we {\it calibrate} $\lambda$'s setting them to be equal to average numbers of isotopes using original {\it full distribution} \eqref{product of multinomials}. For instance, for carbon we set $\lambda_\cem{^{13}C} \approx \cem{c} \times \prob( \cem{^{13}C} )$. This is in contrast to the {\it fitting} approach used in \cite{Breen2000AutomaticPeak,Valkenborg2007UsingPoisson}, where the means of the approximation are free parameter in an optimisation scheme. These two solutions should not differ too much for larger compounds, for it is known that both the Poisson and Multinomial distributions are concentrated near their modes, see \cite{Bobkov1998OnModifiedLogarithmicSobolev}.


Hence, the probability that we assign to reduced configuration \eqref{short chemical formula} is equal to 
\begin{equation}
	\poiss{\text{c}}{13}{1}
	\poiss{\text{h}}{2}{1}
	\poiss{\text{n}}{15}{1}
	\poiss{\text{o}}{17}{1}
	\poiss{\text{s}}{33}{1}
		e^{ - \mu}
	\poiss{\text{o}}{18}{2}	
	\poiss{\text{s}}{34}{2}
		e^{ - \eta }		
	\poiss{\text{s}}{36}{1}
		e^{ - \gamma }
\end{equation}
where 
\begin{align*}\label{intensities summed equation}
	\mu 	&=	\lambda_\cem{^{13}C} + \lambda_\cem{^{2}H} + \lambda_\cem{^{15}N} + \lambda_\cem{^{17}O} +\lambda_\cem{^{33}S}  	\\
	\eta 	&= 	\lambda_\cem{^{18}O} + \lambda_\cem{^{34}S}\\ 
	\gamma	&= 	\lambda_\cem{^{36}S}.
\end{align*}

The usefulness of approximation by a product of independent Poisson lies closed formula expression one obtains while conditioning. 
\begin{lemma}\label{Poisson conditional on sum of Poissons}
	Suppose we have a collection of $m$ independent Poisson-distributed random variables, $X_i \sim \mathrm{Poiss}(\mu_i)$. Then $X_1, \dots, X_m$ given that $X_1 + \dots + X_m = K$ is multinomially distributed,

$$ 
	\Big(X_1, \dots, X_m | X_1 + \dots + X_m = K \Big) 
	\sim 
	\mathrm{Multi}\Big( \frac{\mu_1}{\sigma}, \dots, \frac{\mu_m}{\sigma}; K \Big), 
$$
	where $\sigma = \sum_{i = 1}^m \mu_i$.	
\end{lemma}
Proof might be found in \cite{Kingman1993PoissonProcesses}. 


Suppose that we concentrated on molecule composed of elements that have only one additional neutron, e.g. \smallMolecule. Then, following Lemma \ref{Poisson conditional on sum of Poissons}, the approximative distribution of the {\it localised fine structure} given that we restricted our attention only to configurations with $K$ extra neutrons would simply be 
\begin{equation}\label{Simple Multinomial Eq}
	\mathrm{Multi}\left(\frac{\lambda_\cem{^{13}C}}{\mu}, \frac{\lambda_\cem{^{2}H}}{\mu}, \frac{\lambda_\cem{^{15}N}}{\mu}; \cem{c} + \cem{h} + \cem{n} \right).	
\end{equation}


However, it is not yet clear why should it be true that we can approximate the {\it localised fine structure law} by the Poisson approximation conditional on the set of configurations with the same total number of extra neutrons. What remains to be shown is why the conditioning does not preclude convergence in distribution. This, however, can be easily proved.


\begin{lemma}\label{conditional convergence lemma}
	Let $\mu^{[n]}, \mu$ be discrete measures. If $\mu^{[n]}$ converges in distribution to $\mu$ and an event $A$ has non zero probability under any of that measures, $\underset{n}{\forall} \mu^{[n]}(A)\,,\, \mu(A) > 0$, then measures condtional on $A$, $\mu^{[n]}_A = \frac{\mu^{[n]}}{\mu^{[n]}(A)}$ converge in distribution to $\mu_A = \frac{ \mu }{ \mu(A) }$.
\end{lemma}  
The proof is to be found in the appendix. 


In our case, $\mu^{[n]}_A$ is the projection of {\it full distribution} onto the space of reduced configurations, conditioned on the set $A = \left\{ ( \cem{c}_1, \cem{h}_1, \cem{n}_1 ) :  \cem{c}_1 + \cem{h}_1 + \cem{n}_1 = K\right\}$. That would get approximated by \eqref{Simple Multinomial Eq}. Observe that in probabilistic notation
$$ A =  \left\{ \cem{^{13}C} + \cem{^2H} + \cem{^{15}N} = K \right\}.$$  


It is valuable to see, how Lemma \ref{Poisson conditional on sum of Poissons} generalizes while conditioning on a particular {\it localised fine structure} when the compound is composed out of elements with multiple isotopes. The problem is that the set of configurations with a fixed number of extra neutrons corresponds to a different Diophantine equation\todo{Be sure that the concept of Diophantine equation is introduced.}: namely the condition defining $A$ might be like \eqref{Simple Diophantine Equation}. The Poisson approximation simplifies the calculations of probability assigned to set $A$. It stems from the following


\begin{lemma}\label{sum of independent Poissons lemma}
	Suppose we have a collection of $m$ independent Poisson-distributed random variables, $X_i \sim \mathrm{Poiss}(\mu_i)$. Then $X_1 + \dots + X_m \sim \mathrm{Poiss}(\mu_1 + \dots + \mu_m)$. 
\end{lemma}  
The proof can be found in \cite{Kingman1993PoissonProcesses}. 


Note that $A$ can be described by sums of three different Poisson variables instead of eight:
\begin{equation}\label{setA}
	A = \Big\{ \underbrace{\cem{^{13}C} + \cem{^2H} + \cem{^{15}N} + \cem{^{17}O} + \cem{^{33}S}}_{ G_1 } + 2 \times \underbrace{( \cem{^{18}O} + \cem{^{34}S} )}_{ G_2 } + 4 \times \underbrace{\cem{^{36}S}}_{ G_4 } = K \Big\}.	
\end{equation}
where $G_1 \sim \mathrm{Poiss}(\mu)$, $G_2 \sim \mathrm{Poiss}(\mu)$, and $G_4 \sim \mathrm{Poiss}(\mu)$. There is a strict link between random variables $G_i$ and the concept of equatransneutronic groups described in \cite{Olson2009Calculations}: it is equal to the total number of atoms in a compound bearing additional $i$ neutrons. Also, let us define three numbers
\begin{align*}
	x 	& = \cem{c_1} + \cem{h_1} + \cem{n_1} + \cem{o_1} + \cem{s_1}, \\	  	
	y 	& = \cem{o_2} + \cem{s_2}, 	\\
	z 	& = \cem{s_4}.
\end{align*}
In \cite{Olson2009Calculations} they are encoded by $k_1, k_2$, and $k_4$; also, $d_{G_i} = i$. Then it is true that

\begin{result}\label{Fine structure law}
	The approximative \emph{fine structure law} with $K$ additional neutrons for \molecule\, is equal to 
	\begin{equation*}
	\mathrm{Multi} \left(
		x;
		\frac{ \lambda_\cem{^{13}C} }{ \mu }, 
		\frac{ \lambda_\cem{^{2} H} }{ \mu }, 
		\frac{ \lambda_\cem{^{15}N} }{ \mu },
		\frac{ \lambda_\cem{^{17}O} }{ \mu }, 
		\frac{ \lambda_\cem{^{33}S} }{  \mu} 
	\right ) \otimes
	\mathrm{Multi} \left(
		y;	
		\frac{ \lambda_\cem{^{18}O} }{ \eta },
		\frac{ \lambda_\cem{^{34}S} }{ \eta } 
	\right) \otimes 
	\mathbb{L}( x, y, z ),
\end{equation*}
	where 
	\begin{equation}\label{equatransneutronic distribution}
		\mathbb{L}( x, y , z) = 
		\frac{ \frac{ \mu^x }{ x! } \frac{ \eta^y}{ y! } \frac{ \gamma^z}{z!} }{ 
			\underset{ x' + 2 y' + 4 z' = K}{\sum} 
				\frac{ \mu^{x'} }{ x'! } 
				\frac{ \eta^{y'}}{ y'! } 
				\frac{ \gamma^{z'}}{z'!}
		}.
	\end{equation}
\end{result}
Thus, Result \ref{Fine structure law} also provides us with \eqref{equatransneutronic distribution} -- a natural distribution on the {\it equatransneutronic configurations}. In general, the elements forming a chemical compound may have different numbers of extra neutrons than $I = \{ 1, 2, 4\}$. For a general set $I$ formula \eqref{equatransneutronic distribution} generalizes to 
\begin{equation*}
	\mathbb{L}( k ) = 
	\frac{ 
		\prod_{i \in I} \frac{ \mu_i^{k_i} }{ {k_i}! } 
	}{ 
		\underset{ \{ k :  \sum_{i \in I} i k_i^*  = K \} }{\sum} 	
		\prod_{i \in I} \frac{ \mu_i^{k_i^*} }{ {k_i^*}! }	
	},
\end{equation*}
where $k$ is an ordered tuple indexed by $I$. Observe, that in nature at most $\# I \leq 10$, which poses a limit on the complexity of calculating all the values of $\mathbb{L}$. We call $\mathbb{L}$ the {\it lucky distribution} and note, that is is equivalent to conditioning $\#I$ independent Poisson distributions with different parameters on the set of solutions to Diophantine equation $\sum_{i \in I} i k_i^*  = K$.